<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneSignal Push Notifications Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .notification-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        .diagnostics {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .diagnostic-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: white;
            border-left: 4px solid #ddd;
        }

        .diagnostic-item.pass {
            border-left-color: #28a745;
        }

        .diagnostic-item.fail {
            border-left-color: #dc3545;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .solution-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .solution-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Push Notifications Demo</h1>
        
        <div id="status" class="status warning">
            Initializing OneSignal...
        </div>

        <div class="solution-box">
            <h3>‚ö†Ô∏è CORS Issue Detected</h3>
            <p>The "Failed to fetch" error occurs because browsers block direct API calls to external services. Here are the solutions:</p>
            <div class="tabs">
                <div class="tab active" onclick="showTab('solution1')">Solution 1: Server Proxy</div>
                <div class="tab" onclick="showTab('solution2')">Solution 2: OneSignal SDK</div>
                <div class="tab" onclick="showTab('solution3')">Solution 3: Netlify/Vercel</div>
            </div>
            
            <div id="solution1" class="tab-content active">
                <h4>Backend Server Proxy (Recommended)</h4>
                <p>Create a backend endpoint that forwards notifications to OneSignal:</p>
                <div class="code-block">
// Node.js Express example
app.post('/api/send-notification', async (req, res) => {
  const { title, message, userId } = req.body;
  
  try {
    const response = await fetch('https://onesignal.com/api/v1/notifications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Basic ' + process.env.ONESIGNAL_REST_API_KEY
      },
      body: JSON.stringify({
        app_id: process.env.ONESIGNAL_APP_ID,
        include_player_ids: [userId],
        headings: {"en": title},
        contents: {"en": message}
      })
    });
    
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
                </div>
            </div>
            
            <div id="solution2" class="tab-content">
                <h4>OneSignal SDK Internal Messaging</h4>
                <p>Use OneSignal's internal messaging instead of REST API:</p>
                <div class="code-block">
// This works without CORS issues
async function sendInternalNotification() {
  try {
    // This method works for in-app notifications
    await OneSignal.sendSelfNotification(
      'Test Title',
      'Test Message',
      'https://your-site.com'
    );
  } catch (error) {
    console.error('Internal notification error:', error);
  }
}
                </div>
            </div>
            
            <div id="solution3" class="tab-content">
                <h4>Serverless Functions</h4>
                <p>Use Netlify Functions or Vercel API routes:</p>
                <div class="code-block">
// netlify/functions/send-notification.js
exports.handler = async (event, context) => {
  const { title, message, userId } = JSON.parse(event.body);
  
  const response = await fetch('https://onesignal.com/api/v1/notifications', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Basic ' + process.env.ONESIGNAL_REST_API_KEY
    },
    body: JSON.stringify({
      app_id: process.env.ONESIGNAL_APP_ID,
      include_player_ids: [userId],
      headings: {"en": title},
      contents: {"en": message}
    })
  });
  
  return {
    statusCode: 200,
    body: JSON.stringify(await response.json())
  };
};
                </div>
            </div>
        </div>

        <button id="subscribeBtn" onclick="subscribeUser()" disabled>
            Subscribe to Notifications
        </button>

        <button id="testBtn" onclick="sendTestNotification()" disabled>
            Send Test Notification (Browser Only)
        </button>

        <div class="notification-form">
            <h3>Send Custom Notification</h3>
            <div class="form-group">
                <label for="notificationTitle">Title:</label>
                <input type="text" id="notificationTitle" placeholder="Enter notification title" value="Hello from OneSignal!">
            </div>
            <div class="form-group">
                <label for="notificationMessage">Message:</label>
                <textarea id="notificationMessage" placeholder="Enter notification message">This is a test notification from your website!</textarea>
            </div>
            <div class="form-group">
                <label for="notificationUrl">URL (optional):</label>
                <input type="url" id="notificationUrl" placeholder="https://example.com">
            </div>
            <button onclick="sendCustomNotification()">Send Custom Notification</button>
        </div>

        <div class="diagnostics">
            <h3>Diagnostics</h3>
            <div id="diagnosticResults">
                Running diagnostics...
            </div>
            <button onclick="runDiagnostics()">Run Diagnostics</button>
        </div>
    </div>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
        // Replace with your actual OneSignal App ID
        const ONESIGNAL_APP_ID = 'b5c066e1-250c-4ea1-89f8-9baa22dc401c';
        
        let OneSignal;
        let isSubscribed = false;
        let userId = null;

        // Initialize OneSignal
        window.addEventListener('load', function() {
            initializeOneSignal();
        });

        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        async function initializeOneSignal() {
            try {
                OneSignal = window.OneSignal || [];
                
                await OneSignal.init({
                    appId: ONESIGNAL_APP_ID,
                    allowLocalhostAsSecureOrigin: true,
                });

                // Check if user is already subscribed
                const isUserSubscribed = await OneSignal.isPushNotificationsEnabled();
                updateSubscriptionStatus(isUserSubscribed);

                if (isUserSubscribed) {
                    userId = await OneSignal.getUserId();
                    console.log('User ID:', userId);
                }

                // Enable buttons
                document.getElementById('subscribeBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                updateStatus('OneSignal initialized successfully!', 'success');
                
                // Run initial diagnostics
                setTimeout(runDiagnostics, 1000);
                
            } catch (error) {
                console.error('OneSignal initialization error:', error);
                updateStatus('OneSignal initialization failed: ' + error.message, 'error');
            }
        }

        async function subscribeUser() {
            try {
                if (!OneSignal) {
                    throw new Error('OneSignal not initialized');
                }

                // Show permission prompt
                updateStatus('Requesting notification permission...', 'warning');
                const permission = await OneSignal.requestPermission();
                
                if (permission) {
                    await OneSignal.registerForPushNotifications();
                    userId = await OneSignal.getUserId();
                    updateSubscriptionStatus(true);
                    updateStatus('Successfully subscribed to notifications!', 'success');
                    console.log('User subscribed with ID:', userId);
                } else {
                    updateStatus('Permission denied. You can enable notifications in your browser settings.', 'error');
                }
            } catch (error) {
                console.error('Subscription error:', error);
                updateStatus('Subscription failed: ' + error.message, 'error');
            }
        }

        async function sendTestNotification() {
            if (!userId) {
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            try {
                // Use OneSignal's internal notification method (works without CORS)
                await OneSignal.sendSelfNotification(
                    'Test Notification',
                    'This is a test notification from your website!',
                    window.location.href,
                    'https://onesignal.com/images/notification_logo.png'
                );
                
                updateStatus('Test notification sent successfully! (Browser notification only)', 'success');
            } catch (error) {
                console.error('Send notification error:', error);
                updateStatus('Failed to send notification: ' + error.message + ' (Try the server proxy solution)', 'error');
            }
        }

        async function sendCustomNotification() {
            if (!userId) {
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const url = document.getElementById('notificationUrl').value || window.location.href;

            if (!title || !message) {
                updateStatus('Please fill in title and message', 'warning');
                return;
            }

            try {
                // Method 1: Try server proxy (if available)
                try {
                    const response = await fetch('/api/send-notification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: title,
                            message: message,
                            userId: userId,
                            url: url
                        })
                    });

                    if (response.ok) {
                        updateStatus('Custom notification sent successfully via server!', 'success');
                        return;
                    }
                } catch (serverError) {
                    console.log('Server proxy not available, trying browser method');
                }

                // Method 2: Browser notification (fallback)
                await OneSignal.sendSelfNotification(
                    title,
                    message,
                    url,
                    'https://onesignal.com/images/notification_logo.png'
                );
                
                updateStatus('Custom notification sent successfully! (Browser notification only)', 'success');
            } catch (error) {
                console.error('Send notification error:', error);
                updateStatus('Failed to send notification: ' + error.message + ' (Implement server proxy for full functionality)', 'error');
            }
        }

        function updateSubscriptionStatus(subscribed) {
            isSubscribed = subscribed;
            const subscribeBtn = document.getElementById('subscribeBtn');
            if (subscribed) {
                subscribeBtn.textContent = 'Subscribed ‚úì';
                subscribeBtn.disabled = true;
            } else {
                subscribeBtn.textContent = 'Subscribe to Notifications';
                subscribeBtn.disabled = false;
            }
        }

        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function runDiagnostics() {
            const diagnosticResults = document.getElementById('diagnosticResults');
            diagnosticResults.innerHTML = 'Running diagnostics...';

            const diagnostics = [];

            // Check HTTPS
            diagnostics.push({
                name: 'HTTPS Check',
                status: window.location.protocol === 'https:' || window.location.hostname === 'localhost' ? 'pass' : 'fail',
                message: window.location.protocol === 'https:' || window.location.hostname === 'localhost' ? 'Site is using HTTPS or localhost' : 'Site must use HTTPS for push notifications'
            });

            // Check OneSignal initialization
            diagnostics.push({
                name: 'OneSignal SDK',
                status: OneSignal ? 'pass' : 'fail',
                message: OneSignal ? 'OneSignal SDK loaded' : 'OneSignal SDK not loaded'
            });

            // Check browser support
            diagnostics.push({
                name: 'Browser Support',
                status: 'serviceWorker' in navigator && 'PushManager' in window ? 'pass' : 'fail',
                message: 'serviceWorker' in navigator && 'PushManager' in window ? 'Browser supports push notifications' : 'Browser does not support push notifications'
            });

            // Check CORS issue
            diagnostics.push({
                name: 'CORS Issue',
                status: 'fail',
                message: 'Direct API calls to OneSignal are blocked by CORS. Use server proxy solution.'
            });

            // Check App ID
            diagnostics.push({
                name: 'App ID Configuration',
                status: ONESIGNAL_APP_ID !== 'YOUR_APP_ID' ? 'pass' : 'fail',
                message: ONESIGNAL_APP_ID !== 'YOUR_APP_ID' ? 'App ID configured' : 'Please replace YOUR_APP_ID with your actual OneSignal App ID'
            });

            // Check subscription status
            if (OneSignal) {
                try {
                    const isEnabled = await OneSignal.isPushNotificationsEnabled();
                    diagnostics.push({
                        name: 'Subscription Status',
                        status: isEnabled ? 'pass' : 'fail',
                        message: isEnabled ? 'User is subscribed to notifications' : 'User is not subscribed to notifications'
                    });
                } catch (error) {
                    diagnostics.push({
                        name: 'Subscription Status',
                        status: 'fail',
                        message: 'Error checking subscription status: ' + error.message
                    });
                }
            }

            // Check permission
            if ('Notification' in window) {
                diagnostics.push({
                    name: 'Notification Permission',
                    status: Notification.permission === 'granted' ? 'pass' : 'fail',
                    message: `Notification permission: ${Notification.permission}`
                });
            }

            // Server proxy check
            try {
                const response = await fetch('/api/send-notification', { method: 'HEAD' });
                diagnostics.push({
                    name: 'Server Proxy',
                    status: response.status !== 404 ? 'pass' : 'fail',
                    message: response.status !== 404 ? 'Server proxy endpoint available' : 'Server proxy endpoint not found'
                });
            } catch (error) {
                diagnostics.push({
                    name: 'Server Proxy',
                    status: 'fail',
                    message: 'Server proxy endpoint not available - implement for full functionality'
                });
            }

            // Render diagnostics
            diagnosticResults.innerHTML = diagnostics.map(diagnostic => `
                <div class="diagnostic-item ${diagnostic.status}">
                    <strong>${diagnostic.name}:</strong> ${diagnostic.message}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
