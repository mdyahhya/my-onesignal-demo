<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneSignal Push Notifications Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .notification-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        .diagnostics {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .diagnostic-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: white;
            border-left: 4px solid #ddd;
        }

        .diagnostic-item.pass {
            border-left-color: #28a745;
        }

        .diagnostic-item.fail {
            border-left-color: #dc3545;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”” Push Notifications Demo</h1>
        
        <div id="status" class="status warning">
            Initializing OneSignal...
        </div>

        <div class="info-box">
            <h3>Setup Instructions:</h3>
            <ol>
                <li>Replace YOUR_APP_ID in the script with your actual OneSignal App ID</li>
                <li>Add required files to your repository</li>
                <li>Deploy to GitHub Pages or Netlify</li>
                <li>Test the notifications</li>
            </ol>
        </div>

        <button id="subscribeBtn" onclick="subscribeUser()" disabled>
            Subscribe to Notifications
        </button>

        <button id="testBtn" onclick="sendTestNotification()" disabled>
            Send Test Notification
        </button>

        <div class="notification-form">
            <h3>Send Custom Notification</h3>
            <div class="form-group">
                <label for="notificationTitle">Title:</label>
                <input type="text" id="notificationTitle" placeholder="Enter notification title" value="Hello from OneSignal!">
            </div>
            <div class="form-group">
                <label for="notificationMessage">Message:</label>
                <textarea id="notificationMessage" placeholder="Enter notification message">This is a test notification from your website!</textarea>
            </div>
            <div class="form-group">
                <label for="notificationUrl">URL (optional):</label>
                <input type="url" id="notificationUrl" placeholder="https://example.com">
            </div>
            <button onclick="sendCustomNotification()">Send Custom Notification</button>
        </div>

        <div class="diagnostics">
            <h3>Diagnostics</h3>
            <div id="diagnosticResults">
                Running diagnostics...
            </div>
            <button onclick="runDiagnostics()">Run Diagnostics</button>
        </div>
    </div>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
        // Replace with your actual OneSignal App ID
        const ONESIGNAL_APP_ID = 'b5c066e1-250c-4ea1-89f8-9baa22dc401c'; // Get this from OneSignal Dashboard
        const ONESIGNAL_REST_API_KEY = 'jurzpcc5se325mpevnmbyaxma'; // Get this from OneSignal Dashboard
        
        let OneSignal;
        let isSubscribed = false;
        let userId = null;

        // Initialize OneSignal
        window.addEventListener('load', function() {
            initializeOneSignal();
        });

        async function initializeOneSignal() {
            try {
                OneSignal = window.OneSignal || [];
                
                await OneSignal.init({
                    appId: ONESIGNAL_APP_ID,
                    safari_web_id: 'YOUR_SAFARI_WEB_ID', // Optional: for Safari
                    notifyButton: {
                        enable: false, // We'll use our custom button
                    },
                    allowLocalhostAsSecureOrigin: true, // For local testing
                });

                // Check if user is already subscribed
                const isUserSubscribed = await OneSignal.isPushNotificationsEnabled();
                updateSubscriptionStatus(isUserSubscribed);

                if (isUserSubscribed) {
                    userId = await OneSignal.getUserId();
                    console.log('User ID:', userId);
                }

                // Enable buttons
                document.getElementById('subscribeBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                updateStatus('OneSignal initialized successfully!', 'success');
                
                // Run initial diagnostics
                setTimeout(runDiagnostics, 1000);
                
            } catch (error) {
                console.error('OneSignal initialization error:', error);
                updateStatus('OneSignal initialization failed: ' + error.message, 'error');
            }
        }

        async function subscribeUser() {
            try {
                if (!OneSignal) {
                    throw new Error('OneSignal not initialized');
                }

                // Check if permission is already granted
                if (Notification.permission === 'granted') {
                    await OneSignal.registerForPushNotifications();
                    userId = await OneSignal.getUserId();
                    updateSubscriptionStatus(true);
                    updateStatus('Successfully subscribed to notifications!', 'success');
                    return;
                }

                // Show custom prompt first (optional)
                const userWantsNotifications = await showCustomPermissionPrompt();
                if (!userWantsNotifications) {
                    updateStatus('You chose not to receive notifications', 'warning');
                    return;
                }

                // Request permission from browser
                updateStatus('Requesting notification permission...', 'warning');
                const permission = await OneSignal.requestPermission();
                
                if (permission) {
                    await OneSignal.registerForPushNotifications();
                    userId = await OneSignal.getUserId();
                    updateSubscriptionStatus(true);
                    updateStatus('Successfully subscribed to notifications!', 'success');
                    console.log('User subscribed with ID:', userId);
                } else {
                    updateStatus('Permission denied. You can enable notifications in your browser settings.', 'error');
                }
            } catch (error) {
                console.error('Subscription error:', error);
                updateStatus('Subscription failed: ' + error.message, 'error');
            }
        }

        // Custom permission prompt (shows before browser prompt)
        function showCustomPermissionPrompt() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 350px; text-align: center; margin: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">ðŸ”” Stay Updated!</h3>
                        <p style="margin-bottom: 20px; color: #666;">Get notified about important updates, news, and special offers.</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="allowNotifications()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Allow</button>
                            <button onclick="denyNotifications()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">No Thanks</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                window.allowNotifications = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };

                window.denyNotifications = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });
        }

        async function sendTestNotification() {
            if (!userId) {
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            try {
                const notification = {
                    app_id: ONESIGNAL_APP_ID,
                    include_player_ids: [userId],
                    headings: {"en": "Test Notification"},
                    contents: {"en": "This is a test notification from your website!"},
                    url: window.location.href
                };

                const response = await fetch('https://onesignal.com/api/v1/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + ONESIGNAL_REST_API_KEY
                    },
                    body: JSON.stringify(notification)
                });

                if (response.ok) {
                    updateStatus('Test notification sent successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.errors ? errorData.errors[0] : 'Failed to send notification');
                }
            } catch (error) {
                console.error('Send notification error:', error);
                updateStatus('Failed to send notification: ' + error.message, 'error');
            }
        }

        async function sendCustomNotification() {
            if (!userId) {
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const url = document.getElementById('notificationUrl').value || window.location.href;

            if (!title || !message) {
                updateStatus('Please fill in title and message', 'warning');
                return;
            }

            try {
                const notification = {
                    app_id: ONESIGNAL_APP_ID,
                    include_player_ids: [userId],
                    headings: {"en": title},
                    contents: {"en": message},
                    url: url
                };

                const response = await fetch('https://onesignal.com/api/v1/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + ONESIGNAL_REST_API_KEY
                    },
                    body: JSON.stringify(notification)
                });

                if (response.ok) {
                    updateStatus('Custom notification sent successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.errors ? errorData.errors[0] : 'Failed to send notification');
                }
            } catch (error) {
                console.error('Send notification error:', error);
                updateStatus('Failed to send notification: ' + error.message, 'error');
            }
        }

        function updateSubscriptionStatus(subscribed) {
            isSubscribed = subscribed;
            const subscribeBtn = document.getElementById('subscribeBtn');
            if (subscribed) {
                subscribeBtn.textContent = 'Subscribed âœ“';
                subscribeBtn.disabled = true;
            } else {
                subscribeBtn.textContent = 'Subscribe to Notifications';
                subscribeBtn.disabled = false;
            }
        }

        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function runDiagnostics() {
            const diagnosticResults = document.getElementById('diagnosticResults');
            diagnosticResults.innerHTML = 'Running diagnostics...';

            const diagnostics = [];

            // Check HTTPS
            diagnostics.push({
                name: 'HTTPS Check',
                status: window.location.protocol === 'https:' ? 'pass' : 'fail',
                message: window.location.protocol === 'https:' ? 'Site is using HTTPS' : 'Site must use HTTPS for push notifications'
            });

            // Check OneSignal initialization
            diagnostics.push({
                name: 'OneSignal SDK',
                status: OneSignal ? 'pass' : 'fail',
                message: OneSignal ? 'OneSignal SDK loaded' : 'OneSignal SDK not loaded'
            });

            // Check browser support
            diagnostics.push({
                name: 'Browser Support',
                status: 'serviceWorker' in navigator ? 'pass' : 'fail',
                message: 'serviceWorker' in navigator ? 'Browser supports push notifications' : 'Browser does not support push notifications'
            });

            // Mobile device detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);

            diagnostics.push({
                name: 'Device Type',
                status: 'pass',
                message: isMobile ? (isIOS ? 'iOS Mobile Device' : (isAndroid ? 'Android Mobile Device' : 'Mobile Device')) : 'Desktop Device'
            });

            // iOS specific checks
            if (isIOS) {
                const isStandalone = window.navigator.standalone;
                diagnostics.push({
                    name: 'iOS Add to Home Screen',
                    status: isStandalone ? 'pass' : 'fail',
                    message: isStandalone ? 'App is installed (added to home screen)' : 'For iOS notifications, please "Add to Home Screen" first'
                });

                const iosVersion = navigator.userAgent.match(/OS (\d+)_(\d+)/);
                const majorVersion = iosVersion ? parseInt(iosVersion[1]) : 0;
                diagnostics.push({
                    name: 'iOS Version',
                    status: majorVersion >= 16 ? 'pass' : 'fail',
                    message: `iOS ${majorVersion}.x detected. iOS 16.4+ required for web push notifications`
                });
            }

            // Check App ID
            diagnostics.push({
                name: 'App ID Configuration',
                status: ONESIGNAL_APP_ID !== 'YOUR_APP_ID' ? 'pass' : 'fail',
                message: ONESIGNAL_APP_ID !== 'YOUR_APP_ID' ? 'App ID configured' : 'Please replace YOUR_APP_ID with your actual OneSignal App ID'
            });

            // Check subscription status
            if (OneSignal) {
                try {
                    const isEnabled = await OneSignal.isPushNotificationsEnabled();
                    diagnostics.push({
                        name: 'Subscription Status',
                        status: isEnabled ? 'pass' : 'fail',
                        message: isEnabled ? 'User is subscribed to notifications' : 'User is not subscribed to notifications'
                    });
                } catch (error) {
                    diagnostics.push({
                        name: 'Subscription Status',
                        status: 'fail',
                        message: 'Error checking subscription status: ' + error.message
                    });
                }
            }

            // Check permission
            if ('Notification' in window) {
                diagnostics.push({
                    name: 'Notification Permission',
                    status: Notification.permission === 'granted' ? 'pass' : (Notification.permission === 'denied' ? 'fail' : 'fail'),
                    message: `Notification permission: ${Notification.permission}`
                });
            }

            // Add mobile-specific guidance
            if (isMobile) {
                diagnostics.push({
                    name: 'Mobile Guidance',
                    status: 'pass',
                    message: isIOS ? 
                        'iOS: Use Safari, tap Share button â†’ Add to Home Screen, then allow notifications' :
                        'Android: Tap "Allow" when permission prompt appears'
                });
            }

            // Render diagnostics
            diagnosticResults.innerHTML = diagnostics.map(diagnostic => `
                <div class="diagnostic-item ${diagnostic.status}">
                    <strong>${diagnostic.name}:</strong> ${diagnostic.message}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
