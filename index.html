<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneSignal Push Notifications Debug</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .debug-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .debug-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }

        .test-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .test-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .timer-display {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        .config-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .config-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .error-box h3 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .api-test-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .api-test-section h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .success-indicator {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .fail-indicator {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Updated OneSignal Debug Mode</h1>
        
        <div id="status" class="status warning">
            Initializing OneSignal...
        </div>

        <div class="config-section">
            <h3>üìã Configuration Check</h3>
            <div id="configStatus">Checking configuration...</div>
        </div>

        <button id="subscribeBtn" onclick="subscribeUser()" disabled>
            Subscribe to Notifications
        </button>

        <div class="api-test-section">
            <h3>üß™ API Test</h3>
            <p>This will test your Netlify function directly:</p>
            <button onclick="testNetlifyFunction()">Test Netlify Function</button>
            <div id="apiTestResult"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Push Notification Test</h3>
            <p>Test actual push notification sending:</p>
            <div class="form-group">
                <label for="testTitle">Test Title:</label>
                <input type="text" id="testTitle" value="Debug Test Notification">
            </div>
            <div class="form-group">
                <label for="testMessage">Test Message:</label>
                <textarea id="testMessage">This is a debug test notification. If you receive this, your setup is working!</textarea>
            </div>
            <button onclick="sendDebugNotification()">Send Debug Notification</button>
            <button onclick="scheduleDebugTest()">Schedule 10-Second Test</button>
            <div id="testTimer" class="timer-display"></div>
        </div>

        <div class="debug-section">
            <h3>üêõ Debug Log</h3>
            <div id="debugLog" class="debug-log">Debug log initialized...\n</div>
            <button onclick="clearDebugLog()">Clear Log</button>
        </div>

        <div class="error-box">
            <h3>‚ùå Common Issues & Solutions</h3>
            <p><strong>1. Missing REST API Key:</strong></p>
            <div class="code-block">
Go to OneSignal Dashboard ‚Üí Settings ‚Üí Keys & IDs
Copy your "REST API Key" 
Add to Netlify: Site Settings ‚Üí Environment Variables
ONESIGNAL_REST_API_KEY = your_key_here
            </div>
            
            <p><strong>2. Missing App ID:</strong></p>
            <div class="code-block">
Add to Netlify Environment Variables:
ONESIGNAL_APP_ID = b5c066e1-250c-4ea1-89f8-9baa22dc401c
            </div>
            
            <p><strong>3. Netlify Function Not Working:</strong></p>
            <div class="code-block">
Check your netlify/functions/send-notification.js file exists
Check Netlify deploy logs for errors
Ensure environment variables are set correctly
            </div>
        </div>
    </div>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
        const ONESIGNAL_APP_ID = 'b5c066e1-250c-4ea1-89f8-9baa22dc401c';
        
        let OneSignal;
        let isSubscribed = false;
        let userId = null;
        let testTimer = null;

        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[OneSignal Debug] ${message}`);
        }

        function clearDebugLog() {
            document.getElementById('debugLog').textContent = 'Debug log cleared...\n';
        }

        window.addEventListener('load', function() {
            debugLog('Page loaded, initializing OneSignal...');
            initializeOneSignal();
        });

        async function initializeOneSignal() {
            try {
                debugLog('Starting OneSignal initialization...');
                OneSignal = window.OneSignal || [];
                
                await OneSignal.init({
                    appId: ONESIGNAL_APP_ID,
                    allowLocalhostAsSecureOrigin: true,
                });

                debugLog('OneSignal initialized successfully');
                
                // Check if user is already subscribed
                const isUserSubscribed = await OneSignal.isPushNotificationsEnabled();
                debugLog(`User subscription status: ${isUserSubscribed}`);
                
                updateSubscriptionStatus(isUserSubscribed);

                if (isUserSubscribed) {
                    userId = await OneSignal.getUserId();
                    debugLog(`User ID: ${userId}`);
                }

                // Enable buttons
                document.getElementById('subscribeBtn').disabled = false;
                
                updateStatus('OneSignal initialized successfully!', 'success');
                checkConfiguration();
                
            } catch (error) {
                debugLog(`OneSignal initialization error: ${error.message}`);
                updateStatus('OneSignal initialization failed: ' + error.message, 'error');
            }
        }

        async function checkConfiguration() {
            const configDiv = document.getElementById('configStatus');
            let configHtml = '';

            // Check HTTPS
            const isHttps = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
            configHtml += `<div class="${isHttps ? 'success' : 'fail'}-indicator">HTTPS: ${isHttps ? 'OK' : 'REQUIRED'}</div>`;

            // Check App ID
            const hasAppId = ONESIGNAL_APP_ID !== 'YOUR_APP_ID';
            configHtml += `<div class="${hasAppId ? 'success' : 'fail'}-indicator">App ID: ${hasAppId ? 'OK' : 'NOT SET'}</div>`;

            // Check browser support
            const browserSupport = 'serviceWorker' in navigator && 'PushManager' in window;
            configHtml += `<div class="${browserSupport ? 'success' : 'fail'}-indicator">Browser Support: ${browserSupport ? 'OK' : 'NOT SUPPORTED'}</div>`;

            // Check notification permission
            const permission = 'Notification' in window ? Notification.permission : 'not supported';
            configHtml += `<div class="${permission === 'granted' ? 'success' : 'fail'}-indicator">Permission: ${permission}</div>`;

            configDiv.innerHTML = configHtml;
        }

        async function subscribeUser() {
            try {
                debugLog('Requesting notification permission...');
                
                if (!OneSignal) {
                    throw new Error('OneSignal not initialized');
                }

                updateStatus('Requesting notification permission...', 'warning');
                const permission = await OneSignal.requestPermission();
                debugLog(`Permission result: ${permission}`);
                
                if (permission) {
                    debugLog('Registering for push notifications...');
                    await OneSignal.registerForPushNotifications();
                    userId = await OneSignal.getUserId();
                    debugLog(`User registered with ID: ${userId}`);
                    
                    updateSubscriptionStatus(true);
                    updateStatus('Successfully subscribed to notifications!', 'success');
                    checkConfiguration();
                } else {
                    debugLog('Permission denied by user');
                    updateStatus('Permission denied. Please enable notifications in your browser settings.', 'error');
                }
            } catch (error) {
                debugLog(`Subscription error: ${error.message}`);
                updateStatus('Subscription failed: ' + error.message, 'error');
            }
        }

        async function testNetlifyFunction() {
            debugLog('Testing Netlify function...');
            const resultDiv = document.getElementById('apiTestResult');
            
            if (!userId) {
                resultDiv.innerHTML = '<div class="fail-indicator">Please subscribe to notifications first</div>';
                return;
            }

            try {
                debugLog('Sending test request to Netlify function...');
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: 'Netlify Function Test',
                        message: 'This is a test from the Netlify function',
                        userId: userId,
                        url: window.location.href
                    })
                });

                debugLog(`Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog(`Response data: ${JSON.stringify(data)}`);
                    
                    if (data.id) {
                        resultDiv.innerHTML = `<div class="success-indicator">‚úÖ Netlify function working! Notification ID: ${data.id}</div>`;
                    } else if (data.errors) {
                        resultDiv.innerHTML = `<div class="fail-indicator">‚ùå OneSignal API Error: ${JSON.stringify(data.errors)}</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="fail-indicator">‚ùå Unexpected response: ${JSON.stringify(data)}</div>`;
                    }
                } else {
                    const errorText = await response.text();
                    debugLog(`Error response: ${errorText}`);
                    resultDiv.innerHTML = `<div class="fail-indicator">‚ùå HTTP ${response.status}: ${errorText}</div>`;
                }
            } catch (error) {
                debugLog(`Netlify function test error: ${error.message}`);
                resultDiv.innerHTML = `<div class="fail-indicator">‚ùå Function not available: ${error.message}</div>`;
            }
        }

        async function sendDebugNotification() {
            if (!userId) {
                debugLog('Cannot send notification - user not subscribed');
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            const title = document.getElementById('testTitle').value;
            const message = document.getElementById('testMessage').value;

            debugLog(`Sending debug notification: ${title} - ${message}`);

            try {
                // Try server proxy first
                debugLog('Attempting to send via Netlify function...');
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        message: message,
                        userId: userId,
                        url: window.location.href
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    debugLog(`Server notification sent successfully: ${JSON.stringify(data)}`);
                    updateStatus('Debug notification sent via server!', 'success');
                } else {
                    const errorText = await response.text();
                    debugLog(`Server notification failed: ${errorText}`);
                    
                    // Fallback to browser notification
                    debugLog('Falling back to browser notification...');
                    await OneSignal.sendSelfNotification(
                        title,
                        message,
                        window.location.href
                    );
                    debugLog('Browser notification sent successfully');
                    updateStatus('Debug notification sent via browser (fallback)', 'success');
                }
            } catch (error) {
                debugLog(`Debug notification error: ${error.message}`);
                updateStatus('Failed to send debug notification: ' + error.message, 'error');
            }
        }

        function scheduleDebugTest() {
            if (!userId) {
                debugLog('Cannot schedule test - user not subscribed');
                updateStatus('Please subscribe first', 'warning');
                return;
            }

            debugLog('Scheduling 10-second test notification...');
            
            // Start countdown
            let seconds = 10;
            const timerDiv = document.getElementById('testTimer');
            
            if (testTimer) {
                clearInterval(testTimer);
            }
            
            testTimer = setInterval(() => {
                timerDiv.textContent = `Test notification in: ${seconds} seconds`;
                seconds--;
                
                if (seconds < 0) {
                    clearInterval(testTimer);
                    timerDiv.textContent = 'Sending test notification now...';
                    
                    // Send the notification
                    sendScheduledTestNotification();
                }
            }, 1000);
            
            updateStatus('10-second test scheduled! You can close the website now.', 'success');
        }

        async function sendScheduledTestNotification() {
            const title = 'Scheduled Test Notification';
            const message = 'This is a scheduled test notification. If you received this while the website was closed, it works!';
            
            debugLog('Sending scheduled test notification...');

            try {
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        message: message,
                        userId: userId,
                        url: window.location.href
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    debugLog(`Scheduled notification sent successfully: ${JSON.stringify(data)}`);
                    document.getElementById('testTimer').textContent = 'Test notification sent!';
                } else {
                    const errorText = await response.text();
                    debugLog(`Scheduled notification failed: ${errorText}`);
                    document.getElementById('testTimer').textContent = 'Test notification failed!';
                }
            } catch (error) {
                debugLog(`Scheduled notification error: ${error.message}`);
                document.getElementById('testTimer').textContent = 'Test notification error!';
            }
        }

        function updateSubscriptionStatus(subscribed) {
            isSubscribed = subscribed;
            const subscribeBtn = document.getElementById('subscribeBtn');
            if (subscribed) {
                subscribeBtn.textContent = 'Subscribed ‚úì';
                subscribeBtn.disabled = true;
            } else {
                subscribeBtn.textContent = 'Subscribe to Notifications';
                subscribeBtn.disabled = false;
            }
        }

        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            debugLog(`Status update: ${message}`);
        }
    </script>
</body>
</html>
